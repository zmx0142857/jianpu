var J=Object.create;var P=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var Z=Object.getOwnPropertyNames;var Q=Object.getPrototypeOf,W=Object.prototype.hasOwnProperty;var Y=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var K=(e,t,i,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let f of Z(t))!W.call(e,f)&&f!==i&&P(e,f,{get:()=>t[f],enumerable:!(a=X(t,f))||a.enumerable});return e};var ee=(e,t,i)=>(i=e!=null?J(Q(e)):{},K(t||!e||!e.__esModule?P(i,"default",{value:e,enumerable:!0}):i,e));var q=Y((G,E)=>{(function(e,t){typeof E=="object"&&E.exports?E.exports=t():e.nearley=t()})(G,function(){function e(r,n,o){return this.id=++e.highestId,this.name=r,this.symbols=n,this.postprocess=o,this}e.highestId=0,e.prototype.toString=function(r){var n=typeof r>"u"?this.symbols.map(h).join(" "):this.symbols.slice(0,r).map(h).join(" ")+" \u25CF "+this.symbols.slice(r).map(h).join(" ");return this.name+" \u2192 "+n};function t(r,n,o,s){this.rule=r,this.dot=n,this.reference=o,this.data=[],this.wantedBy=s,this.isComplete=this.dot===r.symbols.length}t.prototype.toString=function(){return"{"+this.rule.toString(this.dot)+"}, from: "+(this.reference||0)},t.prototype.nextState=function(r){var n=new t(this.rule,this.dot+1,this.reference,this.wantedBy);return n.left=this,n.right=r,n.isComplete&&(n.data=n.build(),n.right=void 0),n},t.prototype.build=function(){var r=[],n=this;do r.push(n.right.data),n=n.left;while(n.left);return r.reverse(),r},t.prototype.finish=function(){this.rule.postprocess&&(this.data=this.rule.postprocess(this.data,this.reference,l.fail))};function i(r,n){this.grammar=r,this.index=n,this.states=[],this.wants={},this.scannable=[],this.completed={}}i.prototype.process=function(r){for(var n=this.states,o=this.wants,s=this.completed,p=0;p<n.length;p++){var c=n[p];if(c.isComplete){if(c.finish(),c.data!==l.fail){for(var m=c.wantedBy,$=m.length;$--;){var b=m[$];this.complete(b,c)}if(c.reference===this.index){var y=c.rule.name;(this.completed[y]=this.completed[y]||[]).push(c)}}}else{var y=c.rule.symbols[c.dot];if(typeof y!="string"){this.scannable.push(c);continue}if(o[y]){if(o[y].push(c),s.hasOwnProperty(y))for(var d=s[y],$=0;$<d.length;$++){var x=d[$];this.complete(c,x)}}else o[y]=[c],this.predict(y)}}},i.prototype.predict=function(r){for(var n=this.grammar.byName[r]||[],o=0;o<n.length;o++){var s=n[o],p=this.wants[r],c=new t(s,0,this.index,p);this.states.push(c)}},i.prototype.complete=function(r,n){var o=r.nextState(n);this.states.push(o)};function a(r,n){this.rules=r,this.start=n||this.rules[0].name;var o=this.byName={};this.rules.forEach(function(s){o.hasOwnProperty(s.name)||(o[s.name]=[]),o[s.name].push(s)})}a.fromCompiled=function(s,n){var o=s.Lexer;s.ParserStart&&(n=s.ParserStart,s=s.ParserRules);var s=s.map(function(c){return new e(c.name,c.symbols,c.postprocess)}),p=new a(s,n);return p.lexer=o,p};function f(){this.reset("")}f.prototype.reset=function(r,n){this.buffer=r,this.index=0,this.line=n?n.line:1,this.lastLineBreak=n?-n.col:0},f.prototype.next=function(){if(this.index<this.buffer.length){var r=this.buffer[this.index++];return r===`
`&&(this.line+=1,this.lastLineBreak=this.index),{value:r}}},f.prototype.save=function(){return{line:this.line,col:this.index-this.lastLineBreak}},f.prototype.formatError=function(r,n){var o=this.buffer;if(typeof o=="string"){var s=o.split(`
`).slice(Math.max(0,this.line-5),this.line),p=o.indexOf(`
`,this.index);p===-1&&(p=o.length);var c=this.index-this.lastLineBreak,m=String(this.line).length;return n+=" at line "+this.line+" col "+c+`:

`,n+=s.map(function(b,y){return $(this.line-s.length+y+1,m)+" "+b},this).join(`
`),n+=`
`+$("",m+c)+`^
`,n}else return n+" at index "+(this.index-1);function $(b,y){var d=String(b);return Array(y-d.length+1).join(" ")+d}};function l(r,n,o){if(r instanceof a)var s=r,o=n;else var s=a.fromCompiled(r,n);this.grammar=s,this.options={keepHistory:!1,lexer:s.lexer||new f};for(var p in o||{})this.options[p]=o[p];this.lexer=this.options.lexer,this.lexerState=void 0;var c=new i(s,0),m=this.table=[c];c.wants[s.start]=[],c.predict(s.start),c.process(),this.current=0}l.fail={},l.prototype.feed=function(r){var n=this.lexer;n.reset(r,this.lexerState);for(var o;;){try{if(o=n.next(),!o)break}catch(R){var m=new i(this.grammar,this.current+1);this.table.push(m);var s=new Error(this.reportLexerError(R));throw s.offset=this.current,s.token=R.token,s}var p=this.table[this.current];this.options.keepHistory||delete this.table[this.current-1];var c=this.current+1,m=new i(this.grammar,c);this.table.push(m);for(var $=o.text!==void 0?o.text:o.value,b=n.constructor===f?o.value:o,y=p.scannable,d=y.length;d--;){var x=y[d],w=x.rule.symbols[x.dot];if(w.test?w.test(b):w.type?w.type===o.type:w.literal===$){var F=x.nextState({data:b,token:o,isToken:!0,reference:c-1});m.states.push(F)}}if(m.process(),m.states.length===0){var s=new Error(this.reportError(o));throw s.offset=this.current,s.token=o,s}this.options.keepHistory&&(p.lexerState=n.save()),this.current++}return p&&(this.lexerState=n.save()),this.results=this.finish(),this},l.prototype.reportLexerError=function(r){var n,o,s=r.token;return s?(n="input "+JSON.stringify(s.text[0])+" (lexer error)",o=this.lexer.formatError(s,"Syntax error")):(n="input (lexer error)",o=r.message),this.reportErrorCommon(o,n)},l.prototype.reportError=function(r){var n=(r.type?r.type+" token: ":"")+JSON.stringify(r.value!==void 0?r.value:r),o=this.lexer.formatError(r,"Syntax error");return this.reportErrorCommon(o,n)},l.prototype.reportErrorCommon=function(r,n){var o=[];o.push(r);var s=this.table.length-2,p=this.table[s],c=p.states.filter(function($){var b=$.rule.symbols[$.dot];return b&&typeof b!="string"});if(c.length===0)o.push("Unexpected "+n+`. I did not expect any more input. Here is the state of my parse table:
`),this.displayStateStack(p.states,o);else{o.push("Unexpected "+n+`. Instead, I was expecting to see one of the following:
`);var m=c.map(function($){return this.buildFirstStateStack($,[])||[$]},this);m.forEach(function($){var b=$[0],y=b.rule.symbols[b.dot],d=this.getSymbolDisplay(y);o.push("A "+d+" based on:"),this.displayStateStack($,o)},this)}return o.push(""),o.join(`
`)},l.prototype.displayStateStack=function(r,n){for(var o,s=0,p=0;p<r.length;p++){var c=r[p],m=c.rule.toString(c.dot);m===o?s++:(s>0&&n.push("    ^ "+s+" more lines identical to this"),s=0,n.push("    "+m)),o=m}},l.prototype.getSymbolDisplay=function(r){return u(r)},l.prototype.buildFirstStateStack=function(r,n){if(n.indexOf(r)!==-1)return null;if(r.wantedBy.length===0)return[r];var o=r.wantedBy[0],s=[r].concat(n),p=this.buildFirstStateStack(o,s);return p===null?null:[r].concat(p)},l.prototype.save=function(){var r=this.table[this.current];return r.lexerState=this.lexerState,r},l.prototype.restore=function(r){var n=r.index;this.current=n,this.table[n]=r,this.table.splice(n+1),this.lexerState=r.lexerState,this.results=this.finish()},l.prototype.rewind=function(r){if(!this.options.keepHistory)throw new Error("set option `keepHistory` to enable rewinding");this.restore(this.table[r])},l.prototype.finish=function(){var r=[],n=this.grammar.start,o=this.table[this.table.length-1];return o.states.forEach(function(s){s.rule.name===n&&s.dot===s.rule.symbols.length&&s.reference===0&&s.data!==l.fail&&r.push(s)}),r.map(function(s){return s.data})};function u(r){var n=typeof r;if(n==="string")return r;if(n==="object"){if(r.literal)return JSON.stringify(r.literal);if(r instanceof RegExp)return"character matching "+r;if(r.type)return r.type+" token";if(r.test)return"token matching "+String(r.test);throw new Error("Unknown symbol type: "+r)}}function h(r){var n=typeof r;if(n==="string")return r;if(n==="object"){if(r.literal)return JSON.stringify(r.literal);if(r instanceof RegExp)return r.toString();if(r.type)return"%"+r.type;if(r.test)return"<"+String(r.test)+">";throw new Error("Unknown symbol type: "+r)}}return{Parser:l,Grammar:a,Rule:e}})});var O=ee(q(),1);function C(e){function t(s){return s[0]}function i(s){return{type:"piece",value:s[0].map(t)}}function a([s,p]){return{type:"piece",value:[...s.map(t),p]}}function f(s){return{type:"bar",value:s[0].map(t)}}function l(s){return{type:"group",value:s[0]}}function u(s){return s[2].map(p=>p[0][0])}function h(s){var m;let p={...s[1],type:"note",tilde:!!s[0]},c=(m=s[2])==null?void 0:m[0][0][1];return c&&(c.type==="dot"?p.dot=s[2][0].length:c.type==="dash"&&(p.dash=s[2][0].length)),p}function r(s){return{value:s[1].value,alter:s[0]?s[0][0].type==="sharp"?1:-1:0,octave:s[2]?s[2][0].type==="hi_octave"?s[2][0].value.length:-s[2][0].value.length:0}}function n(s){return{type:"text",value:s[1]?s[1].value.slice(0,-1):""}}var o={Lexer:e,ParserRules:[{name:"piece",symbols:["_"],postprocess:t},{name:"piece$ebnf$1$subexpression$1",symbols:["bar","_"]},{name:"piece$ebnf$1",symbols:["piece$ebnf$1$subexpression$1"]},{name:"piece$ebnf$1$subexpression$2",symbols:["bar","_"]},{name:"piece$ebnf$1",symbols:["piece$ebnf$1","piece$ebnf$1$subexpression$2"],postprocess:function(p){return p[0].concat([p[1]])}},{name:"piece",symbols:["piece$ebnf$1"],postprocess:i},{name:"piece$ebnf$2",symbols:[]},{name:"piece$ebnf$2$subexpression$1",symbols:["bar","_"]},{name:"piece$ebnf$2",symbols:["piece$ebnf$2","piece$ebnf$2$subexpression$1"],postprocess:function(p){return p[0].concat([p[1]])}},{name:"piece",symbols:["piece$ebnf$2","lastBar"],postprocess:a},{name:"bar",symbols:["lastBar",e.has("bar")?{type:"bar"}:bar],postprocess:t},{name:"lastBar$ebnf$1$subexpression$1",symbols:["group","_"]},{name:"lastBar$ebnf$1",symbols:["lastBar$ebnf$1$subexpression$1"]},{name:"lastBar$ebnf$1$subexpression$2",symbols:["group","_"]},{name:"lastBar$ebnf$1",symbols:["lastBar$ebnf$1","lastBar$ebnf$1$subexpression$2"],postprocess:function(p){return p[0].concat([p[1]])}},{name:"lastBar",symbols:["lastBar$ebnf$1"],postprocess:f},{name:"group",symbols:["note"],postprocess:t},{name:"group",symbols:["paren"],postprocess:l},{name:"paren$ebnf$1$subexpression$1$subexpression$1",symbols:["note"]},{name:"paren$ebnf$1$subexpression$1$subexpression$1",symbols:["paren"]},{name:"paren$ebnf$1$subexpression$1",symbols:["paren$ebnf$1$subexpression$1$subexpression$1","_"]},{name:"paren$ebnf$1",symbols:["paren$ebnf$1$subexpression$1"]},{name:"paren$ebnf$1$subexpression$2$subexpression$1",symbols:["note"]},{name:"paren$ebnf$1$subexpression$2$subexpression$1",symbols:["paren"]},{name:"paren$ebnf$1$subexpression$2",symbols:["paren$ebnf$1$subexpression$2$subexpression$1","_"]},{name:"paren$ebnf$1",symbols:["paren$ebnf$1","paren$ebnf$1$subexpression$2"],postprocess:function(p){return p[0].concat([p[1]])}},{name:"paren",symbols:[e.has("lparen")?{type:"lparen"}:lparen,"_","paren$ebnf$1",e.has("rparen")?{type:"rparen"}:rparen],postprocess:u},{name:"note$ebnf$1$subexpression$1",symbols:[e.has("tilde")?{type:"tilde"}:tilde,"_"]},{name:"note$ebnf$1",symbols:["note$ebnf$1$subexpression$1"],postprocess:t},{name:"note$ebnf$1",symbols:[],postprocess:function(s){return null}},{name:"note$ebnf$2$subexpression$1$ebnf$1$subexpression$1",symbols:["_",e.has("dot")?{type:"dot"}:dot]},{name:"note$ebnf$2$subexpression$1$ebnf$1",symbols:["note$ebnf$2$subexpression$1$ebnf$1$subexpression$1"]},{name:"note$ebnf$2$subexpression$1$ebnf$1$subexpression$2",symbols:["_",e.has("dot")?{type:"dot"}:dot]},{name:"note$ebnf$2$subexpression$1$ebnf$1",symbols:["note$ebnf$2$subexpression$1$ebnf$1","note$ebnf$2$subexpression$1$ebnf$1$subexpression$2"],postprocess:function(p){return p[0].concat([p[1]])}},{name:"note$ebnf$2$subexpression$1",symbols:["note$ebnf$2$subexpression$1$ebnf$1"]},{name:"note$ebnf$2$subexpression$1$ebnf$2$subexpression$1",symbols:["_",e.has("dash")?{type:"dash"}:dash]},{name:"note$ebnf$2$subexpression$1$ebnf$2",symbols:["note$ebnf$2$subexpression$1$ebnf$2$subexpression$1"]},{name:"note$ebnf$2$subexpression$1$ebnf$2$subexpression$2",symbols:["_",e.has("dash")?{type:"dash"}:dash]},{name:"note$ebnf$2$subexpression$1$ebnf$2",symbols:["note$ebnf$2$subexpression$1$ebnf$2","note$ebnf$2$subexpression$1$ebnf$2$subexpression$2"],postprocess:function(p){return p[0].concat([p[1]])}},{name:"note$ebnf$2$subexpression$1",symbols:["note$ebnf$2$subexpression$1$ebnf$2"]},{name:"note$ebnf$2",symbols:["note$ebnf$2$subexpression$1"],postprocess:t},{name:"note$ebnf$2",symbols:[],postprocess:function(s){return null}},{name:"note",symbols:["note$ebnf$1","pitch","note$ebnf$2"],postprocess:h},{name:"pitch$ebnf$1$subexpression$1",symbols:[e.has("sharp")?{type:"sharp"}:sharp]},{name:"pitch$ebnf$1$subexpression$1",symbols:[e.has("flat")?{type:"flat"}:flat]},{name:"pitch$ebnf$1",symbols:["pitch$ebnf$1$subexpression$1"],postprocess:t},{name:"pitch$ebnf$1",symbols:[],postprocess:function(s){return null}},{name:"pitch$ebnf$2$subexpression$1",symbols:[e.has("hi_octave")?{type:"hi_octave"}:hi_octave]},{name:"pitch$ebnf$2$subexpression$1",symbols:[e.has("lo_octave")?{type:"lo_octave"}:lo_octave]},{name:"pitch$ebnf$2",symbols:["pitch$ebnf$2$subexpression$1"],postprocess:t},{name:"pitch$ebnf$2",symbols:[],postprocess:function(s){return null}},{name:"pitch",symbols:["pitch$ebnf$1",e.has("note_name")?{type:"note_name"}:note_name,"pitch$ebnf$2"],postprocess:r},{name:"_$ebnf$1",symbols:[]},{name:"_$ebnf$1$subexpression$1",symbols:[e.has("space")?{type:"space"}:space]},{name:"_$ebnf$1$subexpression$1",symbols:[e.has("newline")?{type:"newline"}:newline]},{name:"_$ebnf$1",symbols:["_$ebnf$1","_$ebnf$1$subexpression$1"],postprocess:function(p){return p[0].concat([p[1]])}},{name:"_",symbols:["_$ebnf$1"],postprocess:s=>""},{name:"text",symbols:[e.has("text")?{type:"text"}:text,e.has("textEnd")?{type:"textEnd"}:textEnd],postprocess:n}],ParserStart:"piece"};return o}var te=Object.prototype.hasOwnProperty,re=Object.prototype.toString,A=typeof new RegExp().sticky=="boolean";function S(e){return e&&re.call(e)==="[object RegExp]"}function V(e){return e&&typeof e=="object"&&!S(e)&&!Array.isArray(e)}function ne(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function se(e){var t=new RegExp("|"+e);return t.exec("").length-1}function ie(e){return"("+e+")"}function H(e){if(!e.length)return"(?!)";var t=e.map(function(i){return"(?:"+i+")"}).join("|");return"(?:"+t+")"}function ae(e){if(typeof e=="string")return"(?:"+ne(e)+")";if(S(e)){if(e.ignoreCase)throw new Error("RegExp /i flag not allowed");if(e.global)throw new Error("RegExp /g flag is implied");if(e.sticky)throw new Error("RegExp /y flag is implied");if(e.multiline)throw new Error("RegExp /m flag is implied");return e.source}else throw new Error("Not a pattern: "+e)}function N(e,t){return e.length>t?e:Array(t-e.length+1).join(" ")+e}function oe(e,t){for(var i=e.length,a=0;;){var f=e.lastIndexOf(`
`,i-1);if(f===-1||(a++,i=f,a===t)||i===0)break}var l=a<t?0:i+1;return e.substring(l).split(`
`)}function le(e){for(var t=Object.getOwnPropertyNames(e),i=[],a=0;a<t.length;a++){var f=t[a],l=e[f],u=[].concat(l);if(f==="include"){for(var h=0;h<u.length;h++)i.push({include:u[h]});continue}var r=[];u.forEach(function(n){V(n)?(r.length&&i.push(k(f,r)),i.push(k(f,n)),r=[]):r.push(n)}),r.length&&i.push(k(f,r))}return i}function ue(e){for(var t=[],i=0;i<e.length;i++){var a=e[i];if(a.include){for(var f=[].concat(a.include),l=0;l<f.length;l++)t.push({include:f[l]});continue}if(!a.type)throw new Error("Rule has no type: "+JSON.stringify(a));t.push(k(a.type,a))}return t}function k(e,t){if(V(t)||(t={match:t}),t.include)throw new Error("Matching rules cannot also include states");var i={defaultType:e,lineBreaks:!!t.error||!!t.fallback,pop:!1,next:null,push:null,error:!1,fallback:!1,value:null,type:null,shouldThrow:!1};for(var a in t)te.call(t,a)&&(i[a]=t[a]);if(typeof i.type=="string"&&e!==i.type)throw new Error("Type transform cannot be a string (type '"+i.type+"' for token '"+e+"')");var f=i.match;return i.match=Array.isArray(f)?f:f?[f]:[],i.match.sort(function(l,u){return S(l)&&S(u)?0:S(u)?-1:S(l)?1:u.length-l.length}),i}function B(e){return Array.isArray(e)?ue(e):le(e)}var pe=k("error",{lineBreaks:!0,shouldThrow:!0});function I(e,t){for(var i=null,a=Object.create(null),f=!0,l=null,u=[],h=[],r=0;r<e.length;r++)e[r].fallback&&(f=!1);for(var r=0;r<e.length;r++){var n=e[r];if(n.include)throw new Error("Inheritance is not allowed in stateless lexers");if(n.error||n.fallback){if(i)throw!n.fallback==!i.fallback?new Error("Multiple "+(n.fallback?"fallback":"error")+" rules not allowed (for token '"+n.defaultType+"')"):new Error("fallback and error are mutually exclusive (for token '"+n.defaultType+"')");i=n}var o=n.match.slice();if(f)for(;o.length&&typeof o[0]=="string"&&o[0].length===1;){var s=o.shift();a[s.charCodeAt(0)]=n}if(n.pop||n.push||n.next){if(!t)throw new Error("State-switching options are not allowed in stateless lexers (for token '"+n.defaultType+"')");if(n.fallback)throw new Error("State-switching options are not allowed on fallback tokens (for token '"+n.defaultType+"')")}if(o.length!==0){f=!1,u.push(n);for(var p=0;p<o.length;p++){var c=o[p];if(S(c)){if(l===null)l=c.unicode;else if(l!==c.unicode&&n.fallback===!1)throw new Error("If one rule is /u then all must be")}}var m=H(o.map(ae)),$=new RegExp(m);if($.test(""))throw new Error("RegExp matches empty string: "+$);var b=se(m);if(b>0)throw new Error("RegExp has capture groups: "+$+`
Use (?: \u2026 ) instead`);if(!n.lineBreaks&&$.test(`
`))throw new Error("Rule should declare lineBreaks: "+$);h.push(ie(m))}}var y=i&&i.fallback,d=A&&!y?"ym":"gm",x=A||y?"":"|";l===!0&&(d+="u");var w=new RegExp(H(h)+x,d);return{regexp:w,groups:u,fast:a,error:i||pe}}function fe(e){var t=I(B(e));return new v({start:t},"start")}function L(e,t,i){var a=e&&(e.push||e.next);if(a&&!i[a])throw new Error("Missing state '"+a+"' (in token '"+e.defaultType+"' of state '"+t+"')");if(e&&e.pop&&+e.pop!=1)throw new Error("pop must be 1 (in token '"+e.defaultType+"' of state '"+t+"')")}function he(e,t){var i=e.$all?B(e.$all):[];delete e.$all;var a=Object.getOwnPropertyNames(e);t||(t=a[0]);for(var f=Object.create(null),l=0;l<a.length;l++){var u=a[l];f[u]=B(e[u]).concat(i)}for(var l=0;l<a.length;l++)for(var u=a[l],h=f[u],r=Object.create(null),n=0;n<h.length;n++){var o=h[n];if(o.include){var s=[n,1];if(o.include!==u&&!r[o.include]){r[o.include]=!0;var p=f[o.include];if(!p)throw new Error("Cannot include nonexistent state '"+o.include+"' (in state '"+u+"')");for(var c=0;c<p.length;c++){var m=p[c];h.indexOf(m)===-1&&s.push(m)}}h.splice.apply(h,s),n--}}for(var $=Object.create(null),l=0;l<a.length;l++){var u=a[l];$[u]=I(f[u],!0)}for(var l=0;l<a.length;l++){for(var b=a[l],y=$[b],d=y.groups,n=0;n<d.length;n++)L(d[n],b,$);for(var x=Object.getOwnPropertyNames(y.fast),n=0;n<x.length;n++)L(y.fast[x[n]],b,$)}return new v($,t)}function ce(e){for(var t=typeof Map<"u",i=t?new Map:Object.create(null),a=Object.getOwnPropertyNames(e),f=0;f<a.length;f++){var l=a[f],u=e[l],h=Array.isArray(u)?u:[u];h.forEach(function(r){if(typeof r!="string")throw new Error("keyword must be string (in keyword '"+l+"')");t?i.set(r,l):i[r]=l})}return function(r){return t?i.get(r):i[r]}}var v=function(e,t){this.startState=t,this.states=e,this.buffer="",this.stack=[],this.reset()};v.prototype.reset=function(e,t){return this.buffer=e||"",this.index=0,this.line=t?t.line:1,this.col=t?t.col:1,this.queuedToken=t?t.queuedToken:null,this.queuedText=t?t.queuedText:"",this.queuedThrow=t?t.queuedThrow:null,this.setState(t?t.state:this.startState),this.stack=t&&t.stack?t.stack.slice():[],this};v.prototype.save=function(){return{line:this.line,col:this.col,state:this.state,stack:this.stack.slice(),queuedToken:this.queuedToken,queuedText:this.queuedText,queuedThrow:this.queuedThrow}};v.prototype.setState=function(e){if(!(!e||this.state===e)){this.state=e;var t=this.states[e];this.groups=t.groups,this.error=t.error,this.re=t.regexp,this.fast=t.fast}};v.prototype.popState=function(){this.setState(this.stack.pop())};v.prototype.pushState=function(e){this.stack.push(this.state),this.setState(e)};var $e=A?function(e,t){return e.exec(t)}:function(e,t){var i=e.exec(t);return i[0].length===0?null:i};v.prototype._getGroup=function(e){for(var t=this.groups.length,i=0;i<t;i++)if(e[i+1]!==void 0)return this.groups[i];throw new Error("Cannot find token type for matched text")};function be(){return this.value}v.prototype.next=function(){var e=this.index;if(this.queuedGroup){var t=this._token(this.queuedGroup,this.queuedText,e);return this.queuedGroup=null,this.queuedText="",t}var i=this.buffer;if(e!==i.length){var u=this.fast[i.charCodeAt(e)];if(u)return this._token(u,i.charAt(e),e);var a=this.re;a.lastIndex=e;var f=$e(a,i),l=this.error;if(f==null)return this._token(l,i.slice(e,i.length),e);var u=this._getGroup(f),h=f[0];return l.fallback&&f.index!==e?(this.queuedGroup=u,this.queuedText=h,this._token(l,i.slice(e,f.index),e)):this._token(u,h,e)}};v.prototype._token=function(e,t,i){var a=0;if(e.lineBreaks){var f=/\n/g,l=1;if(t===`
`)a=1;else for(;f.exec(t);)a++,l=f.lastIndex}var u={type:typeof e.type=="function"&&e.type(t)||e.defaultType,value:typeof e.value=="function"?e.value(t):t,text:t,toString:be,offset:i,lineBreaks:a,line:this.line,col:this.col},h=t.length;if(this.index+=h,this.line+=a,a!==0?this.col=h-l+1:this.col+=h,e.shouldThrow){var r=new Error(this.formatError(u,"invalid syntax"));throw r}return e.pop?this.popState():e.push?this.pushState(e.push):e.next&&this.setState(e.next),u};typeof Symbol<"u"&&Symbol.iterator&&(_=function(e){this.lexer=e},_.prototype.next=function(){var e=this.lexer.next();return{value:e,done:!e}},_.prototype[Symbol.iterator]=function(){return this},v.prototype[Symbol.iterator]=function(){return new _(this)});var _;v.prototype.formatError=function(e,t){if(e==null)var i=this.buffer.slice(this.index),e={text:i,offset:this.index,lineBreaks:i.indexOf(`
`)===-1?0:1,line:this.line,col:this.col};var a=2,f=Math.max(e.line-a,1),l=e.line+a,u=String(l).length,h=oe(this.buffer,this.line-e.line+a+1).slice(0,5),r=[];r.push(t+" at line "+e.line+" col "+e.col+":"),r.push("");for(var n=0;n<h.length;n++){var o=h[n],s=f+n;r.push(N(String(s),u)+"  "+o),s===e.line&&r.push(N("",u+e.col+1)+"^")}return r.join(`
`)};v.prototype.clone=function(){return new v(this.states,this.state)};v.prototype.has=function(e){return!0};var M={compile:fe,states:he,error:Object.freeze({error:!0}),fallback:Object.freeze({fallback:!0}),keywords:ce};var me=()=>M.states({main:{newline:{match:`
`,lineBreaks:!0},space:/[ \t\v\f]+/u,note_name:/[X0-7]/u,finger:/:[X0-9]+/u,text:{match:/"/u,push:"text"},hi_octave:/'+/u,lo_octave:/,+/u,tilde:"~",sup:"^",sub:"_",sharp:"#",flat:"b",dot:".",dash:/-/u,bar:"|",lparen:"(",rparen:")",lbrace:"{",rbrace:"}",langle:"<",rangle:">",identifier:/[a-zA-Z][_0-9a-zA-Z]*/u,comment:/\/\/.*/u},text:{text_end:{match:/(?:\\"|[^"])*"/u,lineBreaks:!0,pop:1}}}),D=me;var g=class{constructor({tag:t,attr:i,children:a}){this.tag=t,this.attr=i,this.children=typeof a=="string"?a:a==null?void 0:a.map(f=>f instanceof g?f:new g(f))}toString(){let{tag:t="",attr:i={},children:a=""}=this,f=typeof a=="string"?a:a.map(u=>u.toString()).join("");if(!t)return f;let l=Object.entries(i).map(([u,h])=>` ${u}="${h}"`).join("");return`<${t}${l}>${f}</${t}>`}};function U(e){var t,i,a="";if(typeof e=="string"||typeof e=="number")a+=e;else if(typeof e=="object")if(Array.isArray(e))for(t=0;t<e.length;t++)e[t]&&(i=U(e[t]))&&(a&&(a+=" "),a+=i);else for(t in e)e[t]&&(a&&(a+=" "),a+=t);return a}function ye(){for(var e,t,i=0,a="";i<arguments.length;)(e=arguments[i++])&&(t=U(e))&&(a&&(a+=" "),a+=t);return a}var T=ye;var de=()=>{let e=(u,h)=>new g({tag:"div",attr:{class:"jianpu"},children:u.value.map(n=>l(n,h))}),t=(u,h)=>{let r=new g({tag:"div",attr:{class:"jianpu-bar"},children:u.value.map(n=>l(n,h))});return h.dist=(h.dist||0)+1,r},i=(u,h)=>new g({tag:"div",attr:{class:"jianpu-group"},children:[l(u.value,h)]}),a=(u,h)=>{h.paren=(h.paren||0)+1;let r=new g({children:u.map(n=>l(n,h))});return h.paren-=1,r},f=(u,h)=>{let r=b=>b<0?"lo"+(b===-1?"":-b):b>0?"hi"+(b===1?"":b):"",n=(b=0)=>b===1?"ul":b>1?"ul"+b:"",o=(b=0,y)=>[{tag:"span",attr:{class:"tilde"+b},children:"\u2322"},{children:y}],s=".".repeat(u.dot||0),p="-".repeat(u.dash||0).split("").join(" "),m=(u.alter===1?"\u266F":u.alter===-1?"\u266D":"")+u.value,$=new g({tag:"span",attr:{class:T("jianpu-note",r(u.octave),n(h.paren))},children:u.tilde?o(h.dist,m):m});return h.dist=1,s||p?(s?h.dist+=1:p&&(h.dist+=u.dash||0),new g({children:[$,{tag:"span",attr:{class:T("jianpu-note",n(h.paren))},children:s||p}]})):$},l=(u,h={})=>{if(Array.isArray(u))return a(u,h);switch(u.type){case"piece":return e(u,h);case"bar":return t(u,h);case"group":return i(u,h);case"note":return f(u,h);default:throw console.error(u),new Error(`unknown ast type ${u.type}`)}};return l},j=de;var z=class{constructor(){let t=this.lexer=D(),i=C(t),a=O.Grammar.fromCompiled(i);this.parser=new O.Parser(a),this.initState=this.parser.save(),this.genHtml=j()}parse(t){if(this.parser.feed(t),this.parser.results.length===0)throw new Error("unexpected end of input");if(this.parser.results.length>1)throw console.dir(this.parser.results,{depth:10}),new Error("ambiguous parse");return this.parser.results[0]}toHtml(t){this.parser.restore(this.initState);let i=this.parse(t);console.dir(i,{depth:10});let a=this.genHtml(i);return console.log(a.toString()),a}};export{z as Jianpu};
